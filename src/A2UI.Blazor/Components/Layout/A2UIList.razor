@using System.Text.Json
@using A2UI.Blazor.Protocol
@using A2UI.Blazor.Services
@inherits A2UIComponentBase

@{
    // Read "data" as a raw path string â€” not via GetString() which would
    // resolve "/path" as a data binding and replace it with the JSON content.
    string? dataPath = Data.Properties?.TryGetValue("data", out var dataEl) == true
        && dataEl.ValueKind == JsonValueKind.String
        ? dataEl.GetString()
        : null;
    var templateElement = GetElement("template");
    var templateComponentId = templateElement.HasValue
        && templateElement.Value.ValueKind == JsonValueKind.Object
        && templateElement.Value.TryGetProperty("componentId", out var cidEl)
            ? cidEl.GetString()
            : null;
}

<div class="a2ui-list">
    @if (dataPath is not null && templateComponentId is not null && SurfaceManager is not null)
    {
        var items = SurfaceManager.ResolveBinding(Surface.SurfaceId, dataPath);
        if (items?.ValueKind == JsonValueKind.Array)
        {
            var index = 0;
            foreach (var item in items.Value.EnumerateArray())
            {
                if (Surface.Components.TryGetValue(templateComponentId, out var templateComp))
                {
                    <CascadingValue Value="@item" Name="ScopeElement">
                        <div class="a2ui-list-item" @key="index">
                            <A2UIComponentRenderer Data="templateComp" Surface="Surface" OnAction="OnAction" />
                        </div>
                    </CascadingValue>
                }
                index++;
            }
        }
    }
    else
    {
        @* Fallback: render children directly *@
        var childIds = GetChildIds();
        foreach (var childId in childIds)
        {
            if (Surface.Components.TryGetValue(childId, out var child))
            {
                <div class="a2ui-list-item">
                    <A2UIComponentRenderer Data="child" Surface="Surface" OnAction="OnAction" />
                </div>
            }
        }
    }
</div>

@code {
    [Parameter]
    public EventCallback<A2UIUserAction> OnAction { get; set; }
}
