@using A2UI.Blazor.Diagnostics
@using A2UI.Blazor.Protocol
@using A2UI.Blazor.Services
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Logging

@if (_componentType is not null)
{
    <ErrorBoundary @ref="_errorBoundary">
        <ChildContent>
            <DynamicComponent Type="_componentType" Parameters="_parameters" />
        </ChildContent>
        <ErrorContent Context="ex">
            @(LogComponentError(ex))
            <div class="a2ui-component-error" role="alert" title="@ex.Message">
                Component "@Data.Component" failed to render
            </div>
        </ErrorContent>
    </ErrorBoundary>
}
else
{
    @(LogUnknownComponent())
    <div class="a2ui-component-unknown" role="status">
        Unknown component: @Data.Component
    </div>
}

@code {
    [Parameter, EditorRequired]
    public A2UIComponentData Data { get; set; } = default!;

    [Parameter, EditorRequired]
    public A2UISurfaceState Surface { get; set; } = default!;

    [CascadingParameter]
    public SurfaceManager? SurfaceManager { get; set; }

    [Parameter]
    public EventCallback<A2UIUserAction> OnAction { get; set; }

    [Inject]
    private ComponentRegistry Registry { get; set; } = default!;

    [Inject]
    private ILogger<A2UIComponentRenderer> Logger { get; set; } = default!;

    private Type? _componentType;
    private Dictionary<string, object>? _parameters;
    private ErrorBoundary? _errorBoundary;
    private string? _lastLoggedUnknown;

    protected override void OnParametersSet()
    {
        _componentType = Registry.Resolve(Data.Component);
        if (_componentType is not null)
        {
            _parameters = new Dictionary<string, object>
            {
                ["Data"] = Data,
                ["Surface"] = Surface
            };

            if (OnAction.HasDelegate && _componentType.GetProperty("OnAction") is not null)
                _parameters["OnAction"] = OnAction;
        }

        // Auto-recover on data update
        _errorBoundary?.Recover();
    }

    private string? LogComponentError(Exception ex)
    {
        Logger.LogError(ex, "Component {ComponentType} failed to render", Data.Component);
        return null;
    }

    private string? LogUnknownComponent()
    {
        if (_lastLoggedUnknown != Data.Component)
        {
            _lastLoggedUnknown = Data.Component;
            Logger.LogWarning(LogEvents.ComponentNotFound, "Unknown component type {ComponentType}", Data.Component);
        }
        return null;
    }
}
